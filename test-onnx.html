<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONNX 模型测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-line {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .log-error { color: #f48771; }
        .log-warn { color: #dcdcaa; }
        .log-info { color: #4fc1ff; }
        .log-success { color: #4ec9b0; }
    </style>
</head>
<body>
    <h1>🐠 AI 鱼检测功能测试</h1>
    
    <div class="test-section">
        <h2>步骤 1: 检查 ONNX Runtime</h2>
        <div id="onnx-status" class="status info">检查中...</div>
        <button onclick="checkONNXRuntime()">重新检查</button>
    </div>
    
    <div class="test-section">
        <h2>步骤 2: 加载模型文件</h2>
        <div id="model-status" class="status info">等待测试...</div>
        <button onclick="loadModel()">加载模型</button>
    </div>
    
    <div class="test-section">
        <h2>步骤 3: 测试推理</h2>
        <div id="inference-status" class="status info">等待测试...</div>
        <canvas id="test-canvas" width="224" height="224" style="border: 1px solid #ccc; display: block; margin: 10px 0;"></canvas>
        <button onclick="testInference()">运行推理测试</button>
    </div>
    
    <div class="test-section">
        <h2>控制台输出</h2>
        <button onclick="clearConsole()">清除日志</button>
        <div id="console-output"></div>
    </div>

    <!-- 加载 ONNX Runtime -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    
    <script>
        let ortSession = null;
        
        // 自定义console日志输出
        const consoleOutput = document.getElementById('console-output');
        
        function addLog(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        function clearConsole() {
            consoleOutput.innerHTML = '';
        }
        
        // 检查 ONNX Runtime
        function checkONNXRuntime() {
            const statusDiv = document.getElementById('onnx-status');
            
            if (typeof window.ort !== 'undefined') {
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '✅ ONNX Runtime 已成功加载<br>版本: ' + (ort.env?.version || '未知');
                addLog('ONNX Runtime 检查通过', 'success');
                addLog('ONNX 版本: ' + (ort.env?.version || '未知'), 'info');
                return true;
            } else {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '❌ ONNX Runtime 未加载！请检查网络连接。';
                addLog('ONNX Runtime 未找到', 'error');
                return false;
            }
        }
        
        // 加载模型
        async function loadModel() {
            const statusDiv = document.getElementById('model-status');
            
            if (!checkONNXRuntime()) {
                addLog('请先确保 ONNX Runtime 已加载', 'error');
                return;
            }
            
            statusDiv.className = 'status info';
            statusDiv.innerHTML = '⏳ 正在加载模型...';
            addLog('开始加载模型: fish_doodle_classifier.onnx', 'info');
            
            try {
                const startTime = performance.now();
                ortSession = await ort.InferenceSession.create('fish_doodle_classifier.onnx');
                const loadTime = (performance.now() - startTime).toFixed(2);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `✅ 模型加载成功！<br>
                    加载时间: ${loadTime}ms<br>
                    输入名称: ${ortSession.inputNames.join(', ')}<br>
                    输出名称: ${ortSession.outputNames.join(', ')}`;
                
                addLog(`模型加载成功，耗时 ${loadTime}ms`, 'success');
                addLog(`输入: ${ortSession.inputNames.join(', ')}`, 'info');
                addLog(`输出: ${ortSession.outputNames.join(', ')}`, 'info');
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `❌ 模型加载失败！<br>错误: ${error.message}`;
                addLog('模型加载失败: ' + error.message, 'error');
                addLog('错误详情: ' + error.stack, 'error');
            }
        }
        
        // 测试推理
        async function testInference() {
            const statusDiv = document.getElementById('inference-status');
            
            if (!ortSession) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '❌ 请先加载模型';
                addLog('推理失败：模型未加载', 'error');
                return;
            }
            
            statusDiv.className = 'status info';
            statusDiv.innerHTML = '⏳ 正在运行推理...';
            addLog('开始推理测试', 'info');
            
            try {
                // 创建测试画布
                const canvas = document.getElementById('test-canvas');
                const ctx = canvas.getContext('2d');
                
                // 绘制一个简单的鱼形状用于测试
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, 224, 224);
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.ellipse(112, 112, 80, 40, 0, 0, 2 * Math.PI);
                ctx.fill();
                
                // 预处理
                addLog('预处理图像数据...', 'info');
                const imageData = ctx.getImageData(0, 0, 224, 224);
                const data = imageData.data;
                
                const input = new Float32Array(1 * 3 * 224 * 224);
                const mean = [0.485, 0.456, 0.406];
                const std = [0.229, 0.224, 0.225];
                
                for (let i = 0; i < 224 * 224; i++) {
                    const pixelIndex = i * 4;
                    const r = data[pixelIndex] / 255.0;
                    const g = data[pixelIndex + 1] / 255.0;
                    const b = data[pixelIndex + 2] / 255.0;
                    
                    input[i] = (r - mean[0]) / std[0];
                    input[i + 224 * 224] = (g - mean[1]) / std[1];
                    input[i + 2 * 224 * 224] = (b - mean[2]) / std[2];
                }
                
                const inputTensor = new ort.Tensor('float32', input, [1, 3, 224, 224]);
                addLog('输入张量形状: [1, 3, 224, 224]', 'info');
                
                // 运行推理
                const startTime = performance.now();
                const feeds = {};
                feeds[ortSession.inputNames[0]] = inputTensor;
                
                addLog('执行模型推理...', 'info');
                const results = await ortSession.run(feeds);
                const inferenceTime = (performance.now() - startTime).toFixed(2);
                
                const outputKey = Object.keys(results)[0];
                const output = results[outputKey].data;
                const logit = output[0];
                const prob = 1 / (1 + Math.exp(-logit));
                const fishProbability = (1 - prob) * 100;
                const isFish = fishProbability >= 60;
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `✅ 推理成功！<br>
                    推理时间: ${inferenceTime}ms<br>
                    鱼概率: ${fishProbability.toFixed(1)}%<br>
                    判定结果: ${isFish ? '✨ 是鱼！' : '⚠️ 不是鱼'}`;
                
                addLog(`推理完成，耗时 ${inferenceTime}ms`, 'success');
                addLog(`Logit 值: ${logit.toFixed(4)}`, 'info');
                addLog(`Sigmoid 概率: ${prob.toFixed(4)}`, 'info');
                addLog(`鱼概率: ${fishProbability.toFixed(1)}%`, isFish ? 'success' : 'warn');
                addLog(`判定: ${isFish ? '是鱼' : '不是鱼'}`, isFish ? 'success' : 'warn');
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `❌ 推理失败！<br>错误: ${error.message}`;
                addLog('推理失败: ' + error.message, 'error');
                addLog('错误详情: ' + error.stack, 'error');
            }
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', () => {
            addLog('页面加载完成', 'success');
            setTimeout(() => {
                checkONNXRuntime();
            }, 500);
        });
    </script>
</body>
</html>

